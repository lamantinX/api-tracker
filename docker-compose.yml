version: '3.8'

services:
  api-watcher:
    build: .
    container_name: api-watcher
    volumes:
      - ./snapshots:/app/snapshots
      - ./urls.json:/app/urls.json
      - ./.env:/app/.env
      - ./logs:/app/logs
    environment:
      - API_WATCHER_SNAPSHOTS_DIR=/app/snapshots
      - API_WATCHER_URLS_FILE=/app/urls.json
      - LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "/app/api_watcher/health_check.py", "--quiet"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Для запуска по расписанию (каждые 30 минут)
    # Раскомментируйте следующие строки и закомментируйте command выше
    # command: >
    #   sh -c "
    #   while true; do
    #     python api_watcher/main.py
    #     sleep 1800
    #   done
    #   "

  # Health check HTTP сервер
  api-watcher-health:
    build: .
    container_name: api-watcher-health
    ports:
      - "8080:8080"
    volumes:
      - ./snapshots:/app/snapshots
      - ./logs:/app/logs
    environment:
      - LOG_LEVEL=INFO
    command: python api_watcher/health_server.py --host 0.0.0.0 --port 8080
    restart: unless-stopped
    depends_on:
      - api-watcher
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Опциональный сервис для веб-интерфейса (будущая функция)
  # api-watcher-web:
  #   build: 
  #     context: .
  #     dockerfile: Dockerfile.web
  #   ports:
  #     - "8081:8080"
  #   depends_on:
  #     - api-watcher
  #   volumes:
  #     - ./snapshots:/app/snapshots